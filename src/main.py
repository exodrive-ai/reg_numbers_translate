import streamlit as st
from pandas import read_excel, DataFrame, ExcelWriter
from io import BytesIO

st.write("""
# –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∑–∞–º–µ–Ω—ã –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –Ω–∞ –ª–∞—Ç–∏–Ω–∏—Ü—É –≤ –≥–æ—Å. –Ω–æ–º–µ—Ä–∞—Ö –∞–≤—Ç–æ.
\n–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ - –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å –≥–æ—Å–Ω–æ–º–µ—Ä–∞–º–∏ –Ω–∞ –∫–∏—Ä–∏–ª–ª–∏—Ü–µ –≤ –≤–µ—Ä—Ö–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ.
""")

def change_letters(reg_number: str) -> str:
    """ –ü–æ–º–µ–Ω—è—Ç—å –∫–∏—Ä–∏–ª–ª–∏—Ü—É –≤ –≥–æ—Å. –Ω–æ–º–µ—Ä–µ –∞–≤—Ç–æ –Ω–∞ –ª–∞—Ç–∏–Ω–∏—Ü—É """
    # Check if input is a string
    if not isinstance(reg_number, str):
        return str(reg_number)  # Convert to string if not already
        
    replace_dict = {'–£': 'Y', '–ö': 'K', '–ï': 'E', '–ù': 'H', '–•': 'X', '–í': 'B',
                    '–ê': 'A', '–†': 'P', '–û': 'O', '–°': 'C', '–ú': 'M', '–¢': 'T'}
    return ''.join(replace_dict.get(char, char) for char in reg_number)

def to_excel(df: DataFrame) -> bytes:
    """ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞—Ç–∞—Ñ—Ä–µ–π–º, –∫–∞–∫ –±–∏–Ω–∞—Ä–Ω–∏–∫ —ç–∫—Å–µ–ª—è """
    output = BytesIO()
    try:
        with ExcelWriter(output, engine='xlsxwriter') as writer:
            df.to_excel(writer, header=False, index=False, sheet_name='Sheet1')
        output.seek(0)  # Reset pointer to beginning of file
        return output.getvalue()
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Excel —Ñ–∞–π–ª–∞: {e}")
        return None

uploaded_file = st.file_uploader(label="–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å—é–¥–∞ –≤–∞—à —Ñ–∞–π–ª —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º xlsx", type=['xlsx'])

if uploaded_file is not None:
    try:
        # Read the uploaded file directly
        df = read_excel(uploaded_file, header=None)
        
        # Validate that the dataframe has at least one column
        if df.shape[1] < 1:
            st.error("–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É —Å –¥–∞–Ω–Ω—ã–º–∏.")
        else:
            # Apply the conversion function to the first column
            df[0] = df[0].apply(change_letters)
            
            # Convert to Excel
            df_xlsx = to_excel(df)
            
            if df_xlsx:
                st.download_button(
                    label='üì• –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç',
                    data=df_xlsx,
                    file_name='reg_numbers.xlsx',
                    mime='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                )
    except Exception as e:
        st.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: {e}")
